image: sbtscala/scala-sbt:graalvm-ce-22.3.0-b2-java17_1.8.2_2.13.10

# before_script:
#   # Enable the usage of sources over https
#   - apt-get update -yqq
#   - apt-get install apt-transport-https -yqq
#   # Add keyserver for SBT
#   - echo "deb https://repo.scala-sbt.org/scalasbt/debian /" | tee -a /etc/apt/sources.list.d/sbt.list
#   - mkdir -p /root/.gnupg
#   - gpg --recv-keys --no-default-keyring --keyring gnupg-ring:/etc/apt/trusted.gpg.d/scalasbt-release.gpg --keyserver hkp://keyserver.ubuntu.com:80 2EE0EA64E40A89B84B2DF73499E82A75642AC823
#   - chmod 644 /etc/apt/trusted.gpg.d/scalasbt-release.gpg
#   # Install SBT
#   - apt-get update -yqq
#   - apt-get install sbt -yqq

stages:
  - compile
  - frontEndTest
  - backEndTest

cache:
  key: "$CI_BUILD_REF_NAME" # contains either the branch or the tag, so it's caching per branch
  untracked: true
  paths:
    - "sbt-cache/.ivy.cache"
    - "sbt-cache/.boot"
    - "sbt-cache/.sbtboot"
    - "sbt-cache/target"

compile_job:
  stage: compile
  script: 
    - echo "compiling..."
    - sbt clean compile
    - echo "compile successful!"

syntax_test: 
  stage: frontEndTest
  script:
    - echo "Running front end syntax unit test..."
    - sbt "Test / testOnly *SyntaxChecker*"
    - echo "test successful!"

semantic_test: 
  stage: frontEndTest
  script:
    - echo "Running front end semantic unit test..."
    - sbt "Test / testOnly *SemanticChecker*"
    - echo "test successful!"

front_int_test:
  stage: frontEndTest
  script:
    - echo "Running front end integration test..."
    - sbt "Test / testOnly *FrontIntegrationTest*"
    - echo "test successful!"

back_unit_test:
  stage: backEndTest
  script:
    - echo "Running back end unit test..."
    - sbt "Test / testOnly *CodeGen*"
    - echo "test successful!"

back_int_test:
  stage: backEndTest
  script:
    - apk update
    - apk add qemu
    - apk add aemu-user
    - apk add gcc-arm-linux-gnueabi
    - echo "Running back end integration test..."
    - sbt "Test / testOnly *IntegrationTests*"
    - echo "test successful!"

    